package textExcel;
 
public class FormulaCell extends RealCell {
 
	private String input;
	private Cell [][] spreadsheet;
	
	public FormulaCell(String value, Cell [][] spreadsheetInput ) {
		super(value);
		input= value;
		spreadsheet = spreadsheetInput;
	}
	
	@Override
	public double getDoubleValue(){
		//separates the components of the formula 
		String [ ] formula = input.substring(2, input.length()-2).split(" ");
		double result=0;
	        if (formula[0].equalsIgnoreCase("SUM")){
	        	result+= getSum(formula[1]);
	        }
	        
	        else if (formula[0].equalsIgnoreCase("AVG")){
	        	result+= getAvg(formula[1]);
	        }
	        		
	        else if (formula[0].toUpperCase().charAt(0)<77&&formula[0].toUpperCase().charAt(0)>64){
				SpreadsheetLocation location= new SpreadsheetLocation (formula[0].toUpperCase());
				result = result + ((RealCell)(spreadsheet[location.getRow()][location.getCol()])).getDoubleValue();
			}
	        
	        else {
	        	result = Double.parseDouble(formula[0]);
	        }
	        		
			for (int i=1; i<formula.length;i+=2 ){
				if (formula[i].equals("+")){
					if (formula[i+1].toUpperCase().charAt(0)>64 &&formula[i+1].toUpperCase().charAt(0)<77){
						SpreadsheetLocation location= new SpreadsheetLocation (formula[i+1].toUpperCase());
						result += ((RealCell)(spreadsheet[location.getRow()][location.getCol()])).getDoubleValue();
					}
					else {
						result+=  Double.parseDouble(formula[i+1]);
					}
			}
				if (formula[i].equals("-")){
					if (formula[i+1].toUpperCase().charAt(0)>64 &&formula[i+1].toUpperCase().charAt(0)<77){
						SpreadsheetLocation location= new SpreadsheetLocation (formula[i+1].toUpperCase());
						result -= ((RealCell)(spreadsheet[location.getRow()][location.getCol()])).getDoubleValue();
					}
					else {
						result-=  Double.parseDouble(formula[i+1]);
					}
				}
				if (formula[i].equals("*")){
					if (formula[i+1].toUpperCase().charAt(0)>64 &&formula[i+1].toUpperCase().charAt(0)<77){
						SpreadsheetLocation location= new SpreadsheetLocation (formula[i+1].toUpperCase());
						result *= ((RealCell)(spreadsheet[location.getRow()][location.getCol()])).getDoubleValue();
					}
					else {
					result*=  Double.parseDouble(formula[i+1]);
					}
				}
				if (formula[i].equals("/")){
					if (formula[i+1].toUpperCase().charAt(0)>64 &&formula[i+1].toUpperCase().charAt(0)<77){
						SpreadsheetLocation location= new SpreadsheetLocation (formula[i+1].toUpperCase());
						result /= ((RealCell)(spreadsheet[location.getRow()][location.getCol()])).getDoubleValue();
					}
					else {
				
					result/=  Double.parseDouble(formula[i+1]);
					}
				}	
		}
		return result;
	}
	
	public double getSum(String input){
		String [] store = input.split("-"); 
		SpreadsheetLocation first = new SpreadsheetLocation(store[0].toUpperCase()); 
		SpreadsheetLocation end = new SpreadsheetLocation(store[1].toUpperCase()); 
		double sum = 0;
		if (end.getRow()==first.getRow() || end.getCol()==first.getCol()){
			return ((RealCell)spreadsheet[first.getRow()][first.getCol()]).getDoubleValue();
		}
		else if (first.getRow() == end.getRow()){
		for (int i = first.getRow(); i< end.getRow(); i++ ){
			for (int j = first.getCol(); j< end.getCol();j++){
//				SpreadsheetLocation additive= new SpreadsheetLocation((char)j+i+"");
				sum += ((RealCell)spreadsheet[i][j]).getDoubleValue(); 
			}
		}
		}
		else if (first.getCol() == end.getCol()){
			for (int j = first.getCol(); j< end.getCol();j++){
				for (int i = first.getRow(); i< end.getRow(); i++ ){
					sum += ((RealCell)spreadsheet[i][j]).getDoubleValue(); 

				}
			}
		return sum; 
		}
			return sum;
	}
	
	public double getAvg(String input){
		String [] store = input.split("-"); 
		SpreadsheetLocation first = new SpreadsheetLocation(store[0]); 
		SpreadsheetLocation end = new SpreadsheetLocation(store[1]); 
		double avg= getSum(input);
		if (end.getRow()==first.getRow() || end.getCol()==first.getCol()){
			return avg;
		}
		else {
			avg /= ((end.getRow()-first.getRow())*(end.getCol()-first.getCol()));
		}
		return avg; 
	}
	@Override
	public String abbreviatedCellText() {
		String Truncatedtext= getDoubleValue() + "          ";
		return Truncatedtext.substring(0,10);
	}
	
	@Override
	public String fullCellText() {
		return super.fullCellText();
	}
}
 